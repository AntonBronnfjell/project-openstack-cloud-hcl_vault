#cloud-config
# Vault Instance Cloud-init Configuration
# Instance will join k3s cluster as worker node (Vault runs on Kubernetes)

users:
  - name: ${deploy_user}
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_authorized_keys:
      - ${ssh_public_key}

package_update: true
package_upgrade: true

packages:
  - curl
  - wget
  - git
  - vim
  - net-tools

write_files:
  - path: /etc/modules-load.d/k8s.conf
    content: |
      overlay
      br_netfilter
    owner: root:root
    permissions: '0644'

  - path: /etc/sysctl.d/k8s.conf
    content: |
      net.bridge.bridge-nf-call-ip6tables = 1
      net.bridge.bridge-nf-call-iptables = 1
      net.ipv4.ip_forward = 1
    owner: root:root
    permissions: '0644'

runcmd:
  # Load kernel modules
  - modprobe overlay
  - modprobe br_netfilter
  
  # Apply sysctl settings
  - sysctl --system
  
  # Install k3s worker (if master IP and token provided)
  %{ if k3s_master_ip != "" && k3s_token != "" ~}
  - curl -sfL https://get.k3s.io | K3S_URL=https://${k3s_master_ip}:6443 K3S_TOKEN=${k3s_token} sh -
  %{ else ~}
  # k3s worker installation will be handled separately
  - echo "Waiting for k3s master configuration..."
  %{ endif ~}
  
  # Create deployment user
  - usermod -aG docker ${deploy_user} || true
  
  # Log completion
  - echo "Vault instance (k3s worker) initialization complete" > /var/log/vault-init.log

final_message: "Vault instance is ready to join k3s cluster"
